{% import 'displayer/items.j2' as disp_item %}

{% macro display_layout(layout = [])%}
    {% if layout["type"] == "VERT" %}
        {{ display_vertical_layout(layout["columns"], layout["containers"], layout["align"], layout["spacing"], layout["height"], layout["background"], layout["user_id"], layout["style"]) }}
    {% elif layout["type"] == "HORIZ" %}
        {{ display_horizontal_layout(layout["columns"], layout["containers"], layout["align"], layout["spacing"]) }}
    {% elif layout["type"] == "TABLE" %}
        {{ display_table_layout(layout["header"], layout["lines"], layout["responsive"], layout["responsive_type"], layout["user_id"]) }}
    {% elif layout["type"] == "TABS" %}
        {{ display_tabs_layout(layout["header"], layout["lines"], layout["user_id"]) }}
    {% elif layout["type"] == "SPACER" %}
        <div><p style="margin-bottom:1cm;"></p></div>
    {% elif layout["type"] == "GRID" %}
        {{ display_grid_layout(layout["grid_config"], layout["containers"], layout["user_id"]) }}
          
    {% endif %}
{% endmacro %}

{% macro display_horizontal_layout(columns=[], containers = [], align = [], spacing = 0) %}
    {# HORIZONTAL layout: single column with items stacked vertically #}
    {# columns[0] defines the Bootstrap column width (e.g., 12 for full width) #}
    {% if columns and columns|length > 0 %}
        <div class="row my-1 {{spacing}}">
            <div class="col-{{columns[0]}} text-{{align[0] if align else 'left'}}">
                {# Display all items in the single container, stacked vertically #}
                {% for element in containers[0] %}
                    {% if element["object"] == "item" %}
                        <div class="mb-2">
                            {{ disp_item.display_item(element) }}
                        </div>
                    {% elif element["object"] == "layout" %}
                        <div class="mb-2">
                            {{ display_layout(element) }}
                        </div>
                    {% else %}
                        NOT SUPPORTED
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro display_vertical_layout(columns=[], containers = [], align = [], spacing = 0, height = 0, background = none, user_id = none, style = none) %}
    <div class="row my-1 {{spacing}} align-items-center {% if background %}bg-{{background}}{% endif %} {% if style %}{{style}}{% endif %}" {% if user_id %} id="{{user_id}}"{% endif %} >
    {# For each columns #}
    {% for col in columns %}
        <div class="col-{{col}} text-{{align[loop.index0]}}">
        
        {# Display all the items in the containers one another #}
        {% for element in containers[loop.index0] %}
            {% if height %}
                <div style="height: {{ height * 50 }}px">
            {% endif %}
                {% if element["object"] == "item" %}
                    {{ disp_item.display_item(element) }}
                {% elif element["object"] == "layout" %}
                {#<div class="row">#}
                    {{ display_layout(element)}}
                {#</div>#}
                {% else %}
                    NOT SUPPORTED
                {% endif %}
            
            {% if height %}
                </div>
            {% endif %}
        {% endfor %}

        </div>
    {% endfor %}
    </div>

{% endmacro %}

{% macro display_table_layout(header=[], lines = [], responsive = None, responsive_type = None, user_id = none) %}    
    <div class="row m-1" {% if user_id %} id="{{user_id}}"{% endif %}>
    <div class="table-responsive">
        <table class="table table-striped mb-0" 
                   {% if responsive %}
                        id="{{ responsive_type }}_{{ responsive }}"                       
                   {% endif %}>
            <thead>
                <tr>
                    {% for head in header %}
                        <th>{{ head }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
            {% if lines %}
                {% for line in lines %}
                    <tr>
                    {% for item in line %}
                        <td>
                            {% for element in item %}
                                {% if element["object"] == "item" %}
                                    {{ disp_item.display_item(element) }}
                                {% elif element["object"] == "layout" %}
                                    {{ display_layout(element)}}
                                {% else %}
                                    NOT SUPPORTED
                                {% endif %}
                            {% endfor %}
                        </td>
                    {% endfor %}
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>

            </table>
        </div>
    </div>
{% endmacro %}

{% macro display_tabs_layout(header=[], lines=[], user_id=none) %}
    {% set tab_id = user_id if user_id else 'myTab' %}
    <ul class="nav nav-tabs" id="{{ tab_id }}" role="tablist">
    {% for head in header %}
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if loop.first %}active{% endif %}" 
        id="{{ tab_id }}_tab{{ loop.index }}" 
        data-bs-toggle="tab" 
        href="#{{ tab_id }}_pane{{ loop.index }}" 
        role="tab" 
        aria-controls="{{ tab_id }}_pane{{ loop.index }}" 
        aria-selected="{{ 'true' if loop.first else 'false' }}">
        {{ head }}
        </a>
    </li>
    {% endfor %}
    </ul>

    <div class="tab-content" id="{{ tab_id }}_content">
    {% for items in lines[0] %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
            id="{{ tab_id }}_pane{{ loop.index }}" 
            role="tabpanel" 
            aria-labelledby="{{ tab_id }}_tab{{ loop.index }}">
            {% for element in items %}
                {% if element["object"] == "item" %}
                    {{ disp_item.display_item(element) }}
                {% elif element["object"] == "layout" %}
                    {{ display_layout(element) }}
                {% else %}
                    NOT SUPPORTED IN TABS for {{ element["object"] }}
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
    </div>
{% endmacro %}

{% macro display_grid_layout(config={}, containers={}, user_id=none) %}
    {# GRID layout: Custom grid based on GridStack configuration #}
    {# Use CSS Grid to match GridStack's positioning capabilities #}
    {% if config and config['items'] %}
        {% set columns = config.get('columns', 12) %}
        {# Calculate grid height: maximum y + h value #}
        {% set max_row = namespace(value=0) %}
        {% for item in config['items'] %}
            {% set item_bottom = item['y'] + item['h'] %}
            {% if item_bottom > max_row.value %}
                {% set max_row.value = item_bottom %}
            {% endif %}
        {% endfor %}
        
        <div class="user-defined-grid" 
             {% if user_id %}id="{{user_id}}"{% endif %}
             style="display: grid; 
                    grid-template-columns: repeat({{columns}}, 1fr); 
                    grid-template-rows: repeat({{max_row.value}}, minmax(60px, auto));
                    gap: 10px;
                    margin: 10px 0;">
            {# Render items with CSS Grid positioning #}
            {% for item_config in config['items'] %}
                {% set field_id = item_config['field_id'] %}
                {% set x = item_config['x'] %}
                {% set y = item_config['y'] %}
                {% set w = item_config['w'] %}
                {% set h = item_config['h'] %}
                
                {# CSS Grid uses 1-based indexing, GridStack uses 0-based #}
                <div class="user-defined-grid-item" 
                     style="grid-column: {{x + 1}} / span {{w}}; 
                            grid-row: {{y + 1}} / span {{h}};">
                    {# Display all elements in this field's container #}
                    {% if field_id in containers %}
                        {% for element in containers[field_id] %}
                            {% if element["object"] == "item" %}
                                {{ disp_item.display_item(element) }}
                            {% elif element["object"] == "layout" %}
                                {{ display_layout(element) }}
                            {% else %}
                                NOT SUPPORTED
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="row my-1" {% if user_id %}id="{{user_id}}"{% endif %}>
            <div class="col-12">
                <div class="alert alert-warning">
                    No GRID layout configuration provided
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}
